<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Alarme de Presença</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header>
        <h1>Sistema de Monitoramento de Presença</h1>
        <div class="status-bar">
            <span class="status-indicator"></span>
            <p id="current-status">Status do Sistema: Monitorando</p>
        </div>
    </header>

    <main>
        <!-- Seção de Alerta Principal -->
        <section class="alert-section">
            <div class="alert-box">
                <h2>Status do Alarme</h2>
                <div id="alert-status">
                    <p class="alert-message">Nenhuma presença detectada</p>
                </div>
            </div>
        </section>

        <!-- Seção de Controles -->
        <section class="controls">
            <h2>Controles do Sistema</h2>
            <div class="button-group">
                <button class="btn-confirm" onclick="buttonAlarme('off')">Confirmar Ciência</button>
                <button class="btn-activate" onclick="buttonAlarme('on')">Ativar Alarme</button>
                <button class="btn-deactivate">Desativar Alarme</button>
            </div>
        </section>

        <!-- Histórico de Eventos -->
        <section class="history">
            <h2>Histórico de Eventos</h2>
            <div class="history-list">
                <ul id="event-list">
                    <!-- Eventos serão inseridos aqui via JavaScript -->
                </ul>
            </div>
        </section>

        <!-- Informações do Sistema -->
        <section class="system-info">
            <h2>Informações do Sistema</h2>
            <div class="info-grid">
                <div class="info-item">
                    <h3>Sensor</h3>
                    <p id="sensor-status">Operacional</p>
                </div>
                <div class="info-item">
                    <h3>Última Atividade</h3>
                    <p id="last-activity">Nenhuma</p>
                </div>
                <div class="info-item">
                    <h3>Estado do Sistema</h3>
                    <p id="system-state">Online</p>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>Sistema de Alarme de Presença - Versão 1.0</p>
    </footer>

    <script>
    let eventHistory = [];
    
    function updateStatus(message, isAlert = false) {
        const statusIndicator = document.querySelector('.status-indicator');
        const alertMessage = document.querySelector('.alert-message');
        const currentStatus = document.getElementById('current-status');
        
        if (isAlert) {
            statusIndicator.style.backgroundColor = '#e74c3c';
            alertMessage.style.color = '#e74c3c';
            addEventToHistory('ALERTA: ' + message);
        } else {
            statusIndicator.style.backgroundColor = '#2ecc71';
        }
        
        alertMessage.textContent = message;
        currentStatus.textContent = 'Status do Sistema: ' + message;
    }

    function buttonAlarme(action) {
        fetch('/control/1/' + action)
            .then(resp => resp.text())
            .then(text => {
                if (text.includes('ALARM_ON')) {
                    updateStatus('Sistema Ativado');
                    addEventToHistory('Sistema Ativado');
                    document.getElementById('system-state').textContent = 'Ativo';
                } else if (text.includes('ALARM_OFF')) {
                    updateStatus('Sistema Desativado');
                    addEventToHistory('Sistema Desativado');
                    document.getElementById('system-state').textContent = 'Desativado';
                }
            })
            .catch(err => {
                updateStatus('Erro: ' + err, true);
            });
    }

    function addEventToHistory(event) {
        const now = new Date();
        const timestamp = now.toLocaleTimeString();
        const eventText = `${timestamp} - ${event}`;
        
        eventHistory.unshift(eventText);
        if (eventHistory.length > 10) eventHistory.pop();
        
        updateEventList();
        document.getElementById('last-activity').textContent = eventText;
    }

    function updateEventList() {
        const eventList = document.getElementById('event-list');
        eventList.innerHTML = '';
        eventHistory.forEach(event => {
            const li = document.createElement('li');
            li.textContent = event;
            eventList.appendChild(li);
        });
    }

    // Polling para verificar o status do sensor
    function pollSensorStatus() {
        fetch('/sensor-status')
            .then(resp => resp.json())
            .then(data => {
                if (data.presence) {
                    updateStatus('PRESENÇA DETECTADA!', true);
                    document.getElementById('sensor-status').textContent = 'Movimento Detectado';
                }
            })
            .catch(err => console.error('Erro ao verificar sensor:', err));
    }

    // Inicializa polling a cada 1 segundo
    setInterval(pollSensorStatus, 1000);

    // Adiciona event listeners para os botões
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelector('.btn-deactivate').addEventListener('click', () => buttonAlarme('off'));
    });
    </script>
</body>
</html>